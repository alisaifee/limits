name: Compatibility

on:
  push:
    branches: ['master']
    tags: ['*']
  schedule:
  - cron: 0 23 * * *
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service_version: ["ALL_LATEST=true"]
        async_redis_implementation: ["coredis"]
        marker: [not integration]
        include:
          - service_version: "LIMITS_REDIS_SERVER_VERSION=8.0"
            marker: "redis or redis_cluster or redis_sentinel"
          - service_version: "LIMITS_REDIS_SERVER_VERSION=7.4"
            marker: "redis or redis_cluster or redis_sentinel"
          - service_version: "LIMITS_REDIS_SERVER_VERSION=7.2"
            marker: "redis or redis_cluster or redis_sentinel"
          - service_version: "LIMITS_REDIS_SERVER_VERSION=7.0"
            marker: "redis or redis_cluster or redis_sentinel"
          - service_version: "LIMITS_REDIS_SERVER_VERSION=7.4"
            marker: "redis or redis_cluster or redis_sentinel"
            async_redis_implementation: "redispy"
          - service_version: "LIMITS_REDIS_SERVER_VERSION=7.2"
            marker: "redis or redis_cluster or redis_sentinel"
            async_redis_implementation: "redispy"
          - service_version: "LIMITS_REDIS_SERVER_VERSION=7.0"
            marker: "redis or redis_cluster or redis_sentinel"
            async_redis_implementation: "redispy"
          - service_version: "LIMITS_MONGODB_SERVER_VERSION=8.0"
            marker: "mongodb"
          - service_version: "LIMITS_MONGODB_SERVER_VERSION=7.0"
            marker: "mongodb"
          - service_version: "LIMITS_MONGODB_SERVER_VERSION=6.0"
            marker: "mongodb"
          - service_version: "LIMITS_MONGODB_SERVER_VERSION=5.0"
            marker: "mongodb"
          - service_version: "LIMITS_MEMCACHED_SERVER_VERSION=1.6.15"
            marker: "memcached"
          - service_version: "LIMITS_MEMCACHED_SERVER_VERSION=1.6.6"
            marker: "memcached"
          - service_version: "LIMITS_MEMCACHED_SERVER_VERSION=1.5.16"
            marker: "memcached"
          - service_version: "LIMITS_VALKEY_SERVER_VERSION=7.2"
            marker: "valkey"
          - service_version: "LIMITS_VALKEY_SERVER_VERSION=8.0"
            marker: "valkey"

    steps:
    - uses: actions/checkout@v4
    - name: Install uv and Python
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        python-version: ${{ matrix.python-version }}
    - name: Setup uv venv
      run: |
        uv sync --locked --all-extras --group ci
    - name: Tests
      env:
        CI: "True"
        ASYNC_REDIS_IMPLEMENTATION: "${{ matrix.async_redis_implementation }}"
      run: |
        eval "export ${{ matrix.service_version }}"
        uv run py.test -m "${{ matrix.marker }} and not benchmark" --cov-report=xml --cov-branch --max-runs=3
